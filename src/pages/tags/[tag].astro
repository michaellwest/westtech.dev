---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import PostCard from "../../components/PostCard.astro";

export async function getStaticPaths() {
  const posts = await getCollection("posts", ({ data }) => !data.draft);

  const tagSet = new Set<string>();
  for (const post of posts) {
    for (const tag of post.data.tags) {
      tagSet.add(tag);
    }
  }

  return [...tagSet].map((tag) => {
    const slug = tag.toLowerCase().replace(/\s+/g, "-");
    const filtered = posts
      .filter((p) => p.data.tags.includes(tag))
      .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

    return {
      params: { tag: slug },
      props: { tag, posts: filtered },
    };
  });
}

const { tag, posts } = Astro.props;
---

<BaseLayout
  title={`#${tag}`}
  description={`All posts tagged with "${tag}" on westtech.dev`}
>
  <Header />

  <main class="flex-1 w-full max-w-2xl mx-auto px-4 sm:px-6 py-10">
    <div class="flex items-center gap-3 mb-8">
      <a
        href="/tags"
        class="text-sm text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"
      >
        â† All tags
      </a>
      <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-50">
        #{tag}
      </h1>
      <span class="text-sm text-zinc-400 dark:text-zinc-500">
        {posts.length} post{posts.length !== 1 ? "s" : ""}
      </span>
    </div>

    {
      posts.map((post) => (
        <PostCard
          title={post.data.title}
          date={post.data.date}
          description={post.data.description}
          tags={post.data.tags}
          slug={post.id}
        />
      ))
    }
  </main>

  <Footer />
</BaseLayout>
